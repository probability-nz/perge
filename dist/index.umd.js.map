{"version":3,"file":"index.umd.js","sources":["../src/index.ts"],"sourcesContent":["import Peer from \"peerjs\";\nimport {\n  init,\n  Connection,\n  DocSet,\n  Doc,\n  ChangeFn,\n  DocSetHandler,\n  change,\n  undo,\n  redo,\n} from \"automerge\";\n\ntype AutomergeUpdateMethod = typeof change | typeof undo | typeof redo;\n\nexport interface PergeConfig {\n  decode?: (msg: string) => any;\n  encode?: (msg: any) => string;\n  peer?: Peer;\n  docSet?: DocSet<any>;\n}\n\nexport default class Perge {\n  readonly peer: Peer;\n  readonly docSet: DocSet<any>;\n\n  private _connections: { [id: string]: Connection<any> } = {};\n  private _actorId: string;\n  private _encode: (msg: any) => string;\n  private _decode: (msg: string) => any;\n\n  constructor(actorId: string, config: PergeConfig = {}) {\n    this._actorId = actorId;\n    this.peer = config.peer || new Peer(this._actorId);\n    this.docSet = config.docSet || new DocSet();\n    this._encode = config.encode || JSON.stringify;\n    this._decode = config.decode || JSON.parse;\n    this.peer.on(\"connection\", (conn) => {\n      if (!this._connections[conn.peer]) this.connect(conn.peer, conn);\n    });\n  }\n\n  public connect(\n    id: string,\n    conn?: Peer.DataConnection,\n    options?: Peer.PeerConnectOption\n  ): Peer.DataConnection {\n    if (this._connections[id]) return this.peer.connections[id];\n    const peer = conn || this.peer.connect(id, options);\n    const connection = (this._connections[id] = new Connection(\n      this.docSet,\n      (msg) => {\n        peer.send(this._encode(msg));\n      }\n    ));\n    const handleMsg = (msg: any) => connection.receiveMsg(this._decode(msg));\n    const cleanup = () => {\n      peer.off(\"data\", handleMsg);\n      if (this._connections[id]) {\n        delete this._connections[id];\n        connection.close();\n      }\n    };\n    peer.on(\"data\", handleMsg);\n    peer.on(\"close\", cleanup);\n    peer.on(\"error\", cleanup);\n    connection.open();\n    return peer;\n  }\n\n  public get<T>(id: string): Doc<T> {\n    return this.docSet.getDoc(id) || init(this._actorId);\n  }\n\n  public select<T>(\n    id: string\n  ): (changeMethod: AutomergeUpdateMethod, ...args: any[]) => Doc<T> {\n    return (changeMethod: Function, ...args: any[]): Doc<T> => {\n      const newDoc = changeMethod(this.get(id), ...args);\n      this.docSet.setDoc(id, newDoc);\n      return newDoc;\n    };\n  }\n\n  public subscribe<T>(\n    idOrSetHandler: string | DocSetHandler<T>,\n    callback?: ChangeFn<T>\n  ): () => void {\n    if (typeof idOrSetHandler === \"function\") {\n      this.docSet.registerHandler(idOrSetHandler);\n      return () => this.docSet.unregisterHandler(idOrSetHandler);\n    }\n    if (typeof idOrSetHandler === \"string\" && !!callback) {\n      const handler = (docId: string, doc: T) => {\n        if (docId === idOrSetHandler) callback(doc);\n      };\n      this.docSet.registerHandler(handler);\n      return () => this.docSet.unregisterHandler(handler);\n    }\n    return () => {};\n  }\n}\n"],"names":["actorId","config","this","_actorId","peer","Peer","docSet","DocSet","_encode","encode","JSON","stringify","_decode","decode","parse","on","conn","_this2","_connections","connect","id","options","connections","connection","Connection","msg","send","_this3","handleMsg","receiveMsg","cleanup","off","close","open","get","getDoc","init","select","changeMethod","newDoc","_this","setDoc","subscribe","idOrSetHandler","callback","registerHandler","_this4","unregisterHandler","handler","docId","doc"],"mappings":"uVA+BE,WAAYA,EAAiBC,uBAAAA,IAAAA,EAAsB,IAL3CC,kBAAkD,GAMxDA,KAAKC,SAAWH,EAChBE,KAAKE,KAAOH,EAAOG,MAAQ,IAAIC,EAAKH,KAAKC,UACzCD,KAAKI,OAASL,EAAOK,QAAU,IAAIC,SACnCL,KAAKM,QAAUP,EAAOQ,QAAUC,KAAKC,UACrCT,KAAKU,QAAUX,EAAOY,QAAUH,KAAKI,MACrCZ,KAAKE,KAAKW,GAAG,aAAc,SAACC,GACrBC,EAAKC,aAAaF,EAAKZ,OAAOa,EAAKE,QAAQH,EAAKZ,KAAMY,gCAIxDG,QAAA,SACLC,EACAJ,EACAK,cAEA,GAAInB,KAAKgB,aAAaE,GAAK,YAAYhB,KAAKkB,YAAYF,GACxD,IAAMhB,EAAOY,GAAQd,KAAKE,KAAKe,QAAQC,EAAIC,GACrCE,EAAcrB,KAAKgB,aAAaE,GAAM,IAAII,aAC9CtB,KAAKI,OACL,SAACmB,GACCrB,EAAKsB,KAAKC,EAAKnB,QAAQiB,MAGrBG,EAAY,SAACH,UAAaF,EAAWM,WAAWF,EAAKf,QAAQa,KAC7DK,EAAU,WACd1B,EAAK2B,IAAI,OAAQH,GACbD,EAAKT,aAAaE,YACbO,EAAKT,aAAaE,GACzBG,EAAWS,UAOf,OAJA5B,EAAKW,GAAG,OAAQa,GAChBxB,EAAKW,GAAG,QAASe,GACjB1B,EAAKW,GAAG,QAASe,GACjBP,EAAWU,OACJ7B,KAGF8B,IAAA,SAAOd,GACZ,YAAYd,OAAO6B,OAAOf,IAAOgB,OAAKlC,KAAKC,aAGtCkC,OAAA,SACLjB,cAEA,gBAAQkB,GACN,IAAMC,EAASD,gBAAaE,EAAKN,IAAId,wCAErC,OADAoB,EAAKlC,OAAOmC,OAAOrB,EAAImB,GAChBA,MAIJG,UAAA,SACLC,EACAC,cAEA,GAA8B,mBAAnBD,EAET,OADAzC,KAAKI,OAAOuC,gBAAgBF,qBACfG,EAAKxC,OAAOyC,kBAAkBJ,IAE7C,GAA8B,iBAAnBA,GAAiCC,EAAU,CACpD,IAAMI,EAAU,SAACC,EAAeC,GAC1BD,IAAUN,GAAgBC,EAASM,IAGzC,OADAhD,KAAKI,OAAOuC,gBAAgBG,qBACfF,EAAKxC,OAAOyC,kBAAkBC,IAE7C"}