{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import Peer from 'peerjs'\nimport { init, Connection, DocSet, Doc, ChangeFn, DocSetHandler, change, undo, redo } from 'automerge'\n\ntype AutomergeUpdateMethod = typeof change | typeof undo | typeof redo\n\nexport interface PergeConfig {\n  decode?: (msg: string) => any\n  encode?: (msg: any) => string\n  peer?: Peer\n  docSet?: DocSet<any>\n}\n\nexport default class Perge {\n  readonly peer: Peer\n  readonly docSet: DocSet<any>\n\n  private _connections: { [id: string]: Connection<any> } = {}\n  private _actorId: string\n  private _encode: (msg: any) => string\n  private _decode: (msg: string) => any\n\n  constructor(actorId: string, config: PergeConfig = {}) {\n    this._actorId = actorId\n    this.peer = config.peer || new Peer(this._actorId)\n    this.docSet = config.docSet || new DocSet()\n    this._encode = config.encode || JSON.stringify\n    this._decode = config.decode || JSON.parse\n    this.peer.on('connection', conn => {\n      if(!this._connections[conn.peer]) this.connect(conn.peer, conn)\n      conn.on('data', msg => {\n        this._connections[conn.peer].receiveMsg(this._decode(msg))\n      })\n    })\n  }\n\n  public connect(id: string, conn?: Peer.DataConnection): Peer.DataConnection {\n    if (this._connections[id]) return this.peer.connections[id]\n    const peer = conn || this.peer.connect(id)\n    const connection = this._connections[id] = new Connection(this.docSet, msg => {\n      peer.send(this._encode(msg))\n    })\n    const cleanup = () => {\n      if(this._connections[id]) {\n        delete this._connections[id]\n        connection.close()\n      }\n    }\n    peer.on('close', cleanup)\n    peer.on('error', cleanup)\n    connection.open()\n    return peer\n  }\n\n  public get<T>(id: string): Doc<T> {\n    return this.docSet.getDoc(id) || init(this._actorId)\n  }\n\n  public select<T>(id: string): (changeMethod: AutomergeUpdateMethod, ...args: any[]) => Doc<T> {\n    return (changeMethod: Function, ...args: any[]): Doc<T> => {\n      const newDoc = changeMethod(this.get(id), ...args)\n      this.docSet.setDoc(id, newDoc)\n      return newDoc\n    }\n  }\n\n  public subscribe<T>(idOrSetHandler: string | DocSetHandler<T>, callback?: ChangeFn<T>): () => void {\n    if (typeof idOrSetHandler === 'function') {\n      this.docSet.registerHandler(idOrSetHandler)\n      return () => this.docSet.unregisterHandler(idOrSetHandler)\n    }\n    if (typeof idOrSetHandler === 'string' && !!callback) {\n      const handler = (docId: string, doc: T) => {\n        if (docId === idOrSetHandler) callback(doc)\n      }\n      this.docSet.registerHandler(handler)\n      return () => this.docSet.unregisterHandler(handler)\n    }\n    return () => { }\n  }\n}\n"],"names":["actorId","config","this","_actorId","peer","Peer","docSet","DocSet","_encode","encode","JSON","stringify","_decode","decode","parse","on","conn","_this2","_connections","connect","msg","receiveMsg","id","connections","connection","Connection","send","_this3","cleanup","close","open","get","getDoc","init","select","changeMethod","newDoc","_this","setDoc","subscribe","idOrSetHandler","callback","registerHandler","_this4","unregisterHandler","handler","docId","doc"],"mappings":"8HAqBE,WAAYA,EAAiBC,uBAAAA,IAAAA,EAAsB,IAL3CC,kBAAkD,GAMxDA,KAAKC,SAAWH,EAChBE,KAAKE,KAAOH,EAAOG,MAAQ,IAAIC,EAAKH,KAAKC,UACzCD,KAAKI,OAASL,EAAOK,QAAU,IAAIC,SACnCL,KAAKM,QAAUP,EAAOQ,QAAUC,KAAKC,UACrCT,KAAKU,QAAUX,EAAOY,QAAUH,KAAKI,MACrCZ,KAAKE,KAAKW,GAAG,aAAc,SAAAC,GACrBC,EAAKC,aAAaF,EAAKZ,OAAOa,EAAKE,QAAQH,EAAKZ,KAAMY,GAC1DA,EAAKD,GAAG,OAAQ,SAAAK,GACdH,EAAKC,aAAaF,EAAKZ,MAAMiB,WAAWJ,EAAKL,QAAQQ,mCAKpDD,QAAA,SAAQG,EAAYN,cACzB,GAAId,KAAKgB,aAAaI,GAAK,YAAYlB,KAAKmB,YAAYD,GACxD,IAAMlB,EAAOY,GAAQd,KAAKE,KAAKe,QAAQG,GACjCE,EAAatB,KAAKgB,aAAaI,GAAM,IAAIG,aAAWvB,KAAKI,OAAQ,SAAAc,GACrEhB,EAAKsB,KAAKC,EAAKnB,QAAQY,MAEnBQ,EAAU,WACXD,EAAKT,aAAaI,YACZK,EAAKT,aAAaI,GACzBE,EAAWK,UAMf,OAHAzB,EAAKW,GAAG,QAASa,GACjBxB,EAAKW,GAAG,QAASa,GACjBJ,EAAWM,OACJ1B,KAGF2B,IAAA,SAAOT,GACZ,YAAYhB,OAAO0B,OAAOV,IAAOW,OAAK/B,KAAKC,aAGtC+B,OAAA,SAAUZ,cACf,gBAAQa,GACN,IAAMC,EAASD,gBAAaE,EAAKN,IAAIT,wCAErC,OADAe,EAAK/B,OAAOgC,OAAOhB,EAAIc,GAChBA,MAIJG,UAAA,SAAaC,EAA2CC,cAC7D,GAA8B,mBAAnBD,EAET,OADAtC,KAAKI,OAAOoC,gBAAgBF,qBACfG,EAAKrC,OAAOsC,kBAAkBJ,IAE7C,GAA8B,iBAAnBA,GAAiCC,EAAU,CACpD,IAAMI,EAAU,SAACC,EAAeC,GAC1BD,IAAUN,GAAgBC,EAASM,IAGzC,OADA7C,KAAKI,OAAOoC,gBAAgBG,qBACfF,EAAKrC,OAAOsC,kBAAkBC,IAE7C"}